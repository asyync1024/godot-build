# Maintainer: LinuxLover471
# Based on: godot (Arch Linux official package)

_pkgname=godot
pkgname=${_pkgname}32-git
pkgver=4.5.r0.g0000000
pkgrel=1
pkgdesc='Advanced cross-platform 2D and 3D game engine (32-bit, git)'
url='https://godotengine.org/'
license=(MIT)
arch=(x86_64)

makedepends=(
  git
  alsa-lib
  pulse-native-provider
  scons
  mold
  setconf
  yasm
)

depends=(
  lib32-brotli
  lib32-freetype2
  lib32-libglvnd
  lib32-libtheora
  lib32-libvorbis
  lib32-libwebp
  lib32-libxcursor
  lib32-libxi
  lib32-libxinerama
  lib32-libxrandr
  lib32-pcre2
)

optdepends=(
  'pipewire-alsa: for audio support'
  'pulse-native-provider: for audio support'
)

conflicts=(godot32)
provides=(godot32)

source=("${_pkgname}::git+https://github.com/godotengine/godot.git")
sha256sums=('SKIP')

pkgver() {
  cd "${srcdir}/${_pkgname}"
  _major=$(grep "^major" version.py | sed 's/major = //')
  _minor=$(grep "^minor" version.py | sed 's/minor = //')
  _revision=$(printf "r%s.%s" "$(git rev-list --count HEAD)" "$(git rev-parse --short HEAD)")
  echo "${_major}.${_minor}.${_revision}"
}

prepare() {
  cd "${srcdir}/${_pkgname}"

  # Patch for miniupnpc (same as non-git pkg)
  sed -i 's/addr, 16/addr, 16, nullptr, 0/g' modules/upnp/upnp.cpp || true

  # Fix the MIME info
  sed -i 's,xmlns="https://specifications.freedesktop.org/shared-mime-info-spec",xmlns="http://www.freedesktop.org/standards/shared-mime-info",g' \
    misc/dist/linux/org.godotengine.Godot.xml || true
}

build() {
  cd "${srcdir}/${_pkgname}"

  export BUILD_NAME=arch_linux
  export _godot_arch=x86_32

  _args=(
    -j$(nproc --all)
    cflags="$CFLAGS -fPIC -Wl,-z,relro,-z,now -w"
    cxxflags="$CXXFLAGS -fPIC -Wl,-z,relro,-z,now -w"
    linkflags="$LDFLAGS"
    arch=$_godot_arch
    bits=32
    linker=mold
    builtin_brotli=no
    builtin_certs=yes
    builtin_clipper2=yes
    builtin_embree=yes
    builtin_enet=yes
    builtin_freetype=no
    builtin_glslang=yes
    builtin_graphite=yes
    builtin_harfbuzz=yes
    builtin_icu4c=yes
    builtin_libogg=no
    builtin_libpng=no
    builtin_libtheora=no
    builtin_libvorbis=no
    builtin_libwebp=no
    builtin_mbedtls=yes
    builtin_miniupnpc=yes
    builtin_msdfgen=yes
    builtin_openxr=yes
    builtin_pcre2=no
    builtin_pcre2_with_jit=no
    builtin_recastnavigation=yes
    builtin_rvo2_2d=yes
    builtin_rvo2_3d=yes
    builtin_squish=yes
    builtin_wslay=yes
    builtin_xatlas=yes
    builtin_zlib=no
    builtin_zstd=no
    colored=yes
    debug_symbols=no
    disable_exceptions=false
    platform=linuxbsd
    production=yes
    pulseaudio=yes
    system_certs_path=/etc/ssl/certs/ca-certificates.crt
    target=editor
    use_llvm=no
    werror=no
  )

  scons "${_args[@]}"
}

package() {
  cd "${srcdir}/${_pkgname}"

  install -Dm755 "bin/godot.linuxbsd.editor.x86_32" \
    "${pkgdir}/usr/bin/godot32"

  install -Dm644 icon.svg \
    "${pkgdir}/usr/share/pixmaps/${pkgname}.svg"

  install -Dm644 misc/dist/linux/org.godotengine.Godot.desktop \
    "${pkgdir}/usr/share/applications/org.godotengine.Godot32.desktop"

  install -Dm644 misc/dist/linux/org.godotengine.Godot.xml \
    "${pkgdir}/usr/share/mime/packages/org.godotengine.Godot32.xml"

  sed -i \
    -e 's|Exec=godot|Exec=godot32|' \
    -e 's|Icon=godot|Icon=godot32|' \
    -e 's|Name=Godot Engine|Name=Godot Engine (32-bit)|' \
    "${pkgdir}/usr/share/applications/org.godotengine.Godot32.desktop"

  install -Dm644 misc/dist/linux/godot.6 \
    "${pkgdir}/usr/share/man/man6/${pkgname}.6"

  install -Dm644 LICENSE.txt \
    "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
}
